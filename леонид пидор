import os
import pandas as pd
import numpy as np

def remove_empty_rows(df):
    """
    Удаляет пустые строки из DataFrame.
    """
    initial_rows = len(df)
    df.dropna(how='all', inplace=True)
    removed_rows = initial_rows - len(df)
    return df, removed_rows

def remove_duplicates(df):
    """
    Удаляет дубликаты строк из DataFrame.
    """
    initial_rows = len(df)
    df.drop_duplicates(inplace=True)
    removed_rows = initial_rows - len(df)
    return df, removed_rows

def remove_low_prices(df, column_name="lot_price", lower_bound=0, upper_bound=100):
    """
    Удаляет строки, где значение в указанном столбце находится в диапазоне [lower_bound, upper_bound].
    """
    if column_name not in df.columns:
        print(f"Предупреждение: столбец {column_name} отсутствует. Пропуск.")
        return df, 0
    
    if not np.issubdtype(df[column_name].dtype, np.number):
        print(f"Предупреждение: столбец {column_name} должен быть числовым. Пропуск.")
        return df, 0
    
    initial_rows = len(df)
    # Удаляем строки, где значения находятся в диапазоне [lower_bound, upper_bound]
    df = df[(df[column_name] < lower_bound) | (df[column_name] > upper_bound)]
    removed_rows = initial_rows - len(df)
    return df, removed_rows

def remove_outliers(df, column_name):
    """
    Удаляет выбросы по указанному числовому столбцу и возвращает их.
    """
    if column_name not in df.columns:
        print(f"Предупреждение: столбец {column_name} отсутствует. Пропуск.")
        return df, pd.DataFrame(), 0
    
    if not np.issubdtype(df[column_name].dtype, np.number):
        print(f"Предупреждение: столбец {column_name} должен быть числовым. Пропуск.")
        return df, pd.DataFrame(), 0
    
    initial_rows = len(df)
    mean = df[column_name].mean()
    std = df[column_name].std()
    lower_bound = mean - 3 * std
    upper_bound = mean + 3 * std
    # Выделяем выбросы
    outliers = df[(df[column_name] < lower_bound) | (df[column_name] > upper_bound)]
    # Оставляем строки без выбросов
    df = df[(df[column_name] >= lower_bound) & (df[column_name] <= upper_bound)]
    removed_rows = initial_rows - len(df)
    return df, outliers, removed_rows

def process_files(file_paths, output_dir, outliers_dir):
    """
    Обрабатывает файлы CSV, удаляя пустые строки, дубликаты, строки с lot_price в диапазоне [0, 100] и выбросы.
    """
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
    if not os.path.exists(outliers_dir):
        os.makedirs(outliers_dir)
    
    total_removed = {"empty_rows": 0, "duplicates": 0, "low_prices": 0, "outliers": 0}
    
    for file_path in file_paths:
        print(f"Обработка файла: {file_path}")
        # Чтение файла
        df = pd.read_csv(file_path)
        
        # Удаление пустых строк
        df, removed_empty = remove_empty_rows(df)
        total_removed["empty_rows"] += removed_empty
        
        # Удаление дубликатов
        df, removed_duplicates_count = remove_duplicates(df)
        total_removed["duplicates"] += removed_duplicates_count
        
        # Удаление строк с lot_price в диапазоне [0, 100]
        if "ml_model_training_data_" in file_path.lower() and "lot_price" in df.columns:
            df, removed_low_prices_count = remove_low_prices(df, "lot_price", lower_bound=0, upper_bound=100)
            total_removed["low_prices"] += removed_low_prices_count
            
            # Удаление выбросов и сохранение в отдельный файл
            df, outliers, removed_outliers_count = remove_outliers(df, "lot_price")
            total_removed["outliers"] += removed_outliers_count
            
            # Сохраняем выбросы в отдельный файл
            outliers_file = os.path.join(outliers_dir, f"outliers_{os.path.basename(file_path)}")
            if not outliers.empty:
                outliers.to_csv(outliers_file, index=False)
                print(f"Выбросы сохранены: {outliers_file}")
        
        # Сохранение обработанного файла
        output_file = os.path.join(output_dir, os.path.basename(file_path))
        df.to_csv(output_file, index=False)
        print(f"Файл сохранен: {output_file}")
    
    print("\nИтоги обработки:")
    print(f"Удалено пустых строк: {total_removed['empty_rows']}")
    print(f"Удалено дубликатов: {total_removed['duplicates']}")
    print(f"Удалено строк с lot_price в диапазоне [0, 100]: {total_removed['low_prices']}")
    print(f"Удалено выбросов: {total_removed['outliers']}")

# Пример использования
if __name__ == "__main__":
    input_files = [
        "ml_model_participants_post_num.csv",
        "ml_model_training_data_2024_10_15_202412042031.csv",
        "ml_model_training_data_items_2024_10_15_202412042038.csv"
    ]
    output_directory = "cleaned_files"
    outliers_directory = "outliers_files"
    process_files(input_files, output_directory, outliers_directory)
